<!DOCTYPE html>
<html>
<head>
    <meta charset="{{ env('APP_CHARSET', 'UTF-8') }}" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>{% block title %}{{ env('APP_TITLE', 'Bet placing') }}{% endblock %}</title>

    <link rel="stylesheet" type="text/css" href="{{ assets('css/main.css') }}">
    {% block stylesheets %}{% endblock %}
    <link rel="icon" type="image/x-icon" href="{{ assets('favicon.ico') }}" />
</head>
<body>

<!-- Navigation bar -->
<header class="header">
    <!-- Logo -->

    {% if isAdmin() %}
        <a href="/admin/bets" class="logo">Ставки</a>
    {% else %}
        <a href="/" class="logo">Главная</a>
    {% endif %}

    <span class="user-name">{{ getUser().name ?? 'гость' }}</span>

    <!-- Hamburger icon -->
    <input class="side-menu" type="checkbox" id="side-menu"/>
    <label class="hamb" for="side-menu"><span class="hamb-line"></span></label>
    <!-- Menu -->
    <nav class="nav">
        <ul class="menu">
            {% if isAdmin() %}
                <li><a href="/admin/users">Пользователи</a></li>
                <li><a href="/admin/amount_logs">Фин. лог</a></li>
            {% endif %}

            {% if isLoggedIn() %}
                <li><a href="/users/logout">Выход</a></li>
            {% else %}
                <li><a href="/users/login">Авторизация</a></li>
                <li><a href="/users/registration">Регистрация</a></li>
            {% endif %}
        </ul>
    </nav>
</header>

<!-- Main content -->
<main>
{% block body %}{% endblock %}
</main>


<script src="{{ assets('js/jquery.min.js') }}"></script>
<script>
    $(function () {

        $('.table-responsive').each(function () {
            const $t = $(this);
            const headers = [];
            $t.find('thead th').each(function (i) {
                headers[i] = $(this).text().trim();
            });
            $t.find('tbody tr').each(function () {
                $(this).children('td').each(function (i) {
                    // не перезаписываем, если уже задано вручную
                    if (!this.hasAttribute('data-th')) {
                        this.setAttribute('data-th', headers[i] ?? '');
                    }
                });
            });
        });

    });
</script>

<script>
    // безопасно экранируем текст, чтобы не прокинуть HTML
    function escapeHtml(s){
        return String(s)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#039;');
    }

    /**
     * Показывает всплывающее сообщение.
     * type: 'success' | 'warning' | 'danger'
     * text: строка (или массив/объект с ошибками)
     * timeoutMs: через сколько скрыть (по умолчанию 4000)
     */
    function flash(type, text, timeoutMs = 4000){
        // поддержим объект/массив ошибок
        if (Array.isArray(text)) text = text.join('\n');
        else if ($.isPlainObject(text)) {
            text = Object.values(text).flat().join('\n');
        }

        const $wrap = $('#flash-container');
        const $el = $(`
    <div class="alert alert-${type}" role="${type==='danger'?'alert':'status'}">
      <div class="alert-body">${escapeHtml(text)}</div>
      <button class="alert-close" aria-label="Закрыть">&times;</button>
    </div>
  `);

        // закрытие по кнопке
        $el.on('click', '.alert-close', function(){ removeEl(); });

        // автозакрытие, пауза при ховере
        let timer = setTimeout(removeEl, timeoutMs);
        $el.on('mouseenter', () => clearTimeout(timer));
        $el.on('mouseleave', () => timer = setTimeout(removeEl, 1200));

        function removeEl(){
            $el.removeClass('show');
            // подождём анимацию
            setTimeout(() => $el.remove(), 200);
        }

        $wrap.append($el);
        // дать браузеру нанести в DOM, потом включить анимацию
        requestAnimationFrame(()=> $el.addClass('show'));
    }
</script>


{% block javascripts %}{% endblock %}
</body>
</html>