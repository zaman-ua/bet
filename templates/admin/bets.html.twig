{% extends 'index.layout.html.twig' %}

{% block body %}
    <section class="content">
        <h1>Ставки</h1>

        <table class="table-responsive">
            <thead>
            <tr>
                <th>created_at</th>
                <th>user_name</th>
                <th>match</th>
                <th>outcome</th>
                <th>stake</th>
                <th>coefficient</th>
                <th>status</th>
                <th>payout</th>
            </tr>
            </thead>
            <tbody>
            {% for bet in bets %}
                <tr>
                    <td>{{ bet.created_at }}</td>
                    <td>{{ bet.user_name }}</td>
                    <td>{{ bet.match }}</td>
                    <td>{{ bet.outcome }}</td>
                    <td>{{ bet.stake }}</td>
                    <td>{{ bet.coefficient }}</td>
                    <td>{{ bet.status }}</td>
                    <td>{{ bet.payout }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </section>
{% endblock %}


{% block javascripts %}
<script>
    $(document).on('click', '.bet', function (e) {
        e.preventDefault();

        const $btn = $(this);
        const $row = $btn.closest('tr');              // ищем всю строку
        const $input = $row.find('input.stake').first(); // инпут в этой строке

        var data = {
            currency_id: 1,
            match_id: $btn.data('id'),
            outcome: $btn.data('outcome'),
            coefficient: $btn.data('coefficient'),
            stake: $input.val(),
            csrf: '{{ csrf_token() }}'
        };

        $.ajax({
            url: '/users/bet',
            method: 'POST',
            data: data,
            dataType: 'json',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            success: function (resp, status, xhr) {
                if (resp?.ok) {
                    // успех — редирект или сообщение
                    window.location = resp.redirect || '/';
                    return;
                }
                if (resp?.error) {
                    renderErrors($form, resp.error);
                    return;
                }
                // если сервер вернул HTML вместо JSON — заменим форму (fallback)
                if (xhr.getResponseHeader('Content-Type')?.includes('text/html')) {
                    $form.replaceWith(resp);
                }
            },
            error: function (xhr) {
                if (xhr.status === 422 || xhr.status === 409 || xhr.status === 400) {
                    const json = xhr.responseJSON || {};
                    alert(json.error);
                } else {
                    alert('Ошибка сервера. Попробуйте позже.');
                }
            },
            // complete: function () {
            //     $btn.prop('disabled', false);
            // }
        });
    });
</script>
{% endblock %}